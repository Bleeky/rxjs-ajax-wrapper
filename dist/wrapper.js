"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _defineProperty2=require("babel-runtime/helpers/defineProperty"),_defineProperty3=_interopRequireDefault(_defineProperty2),_extends3=require("babel-runtime/helpers/extends"),_extends4=_interopRequireDefault(_extends3),_toConsumableArray2=require("babel-runtime/helpers/toConsumableArray"),_toConsumableArray3=_interopRequireDefault(_toConsumableArray2),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_rxjs=require("rxjs"),_ajax=require("rxjs/ajax"),_operators=require("rxjs/operators"),_deepmerge=require("deepmerge"),_deepmerge2=_interopRequireDefault(_deepmerge);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}var RxjsWrapper=function(){function a(b){(0,_classCallCheck3.default)(this,a),this.apiDefs=b,this.routes=[],this.requestMiddlewares=[],this.errorMiddlewares=[],this.buildUrl=this.buildUrl.bind(this),this.defBuilder=this.defBuilder.bind(this),this.init=this.init.bind(this),this.init()}return(0,_createClass3.default)(a,[{key:"buildUrl",value:function e(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},d=a;return Object.keys(b).forEach(function(a){d=d.replace(":"+a,b[a])}),c.constructor===Object&&0<Object.keys(c).length?d=d.concat("?",Object.keys(c).filter(function(a){return c[a]}).map(function(a){return encodeURIComponent(a)+"="+encodeURIComponent(c[a])}).join("&")):c.constructor===String&&(d=d.concat("?",c)),d}},{key:"defBuilder",value:function e(a,b){var c={};this.requestMiddlewares.forEach(function(b){a.ignoreMiddlewares&&a.ignoreMiddlewares.find(function(a){return a===b.name})||(c=(0,_deepmerge2.default)(c,b.handler()))});var d=(0,_deepmerge2.default)(c,b);if(d=(0,_deepmerge2.default)({url:this.buildUrl(a.url,b.params,b.query),method:a.method,responseType:a.responseType?a.responseType:"json",headers:{}},d),a.contentType?d.headers["Content-Type"]=a.contentType:void 0===a.autoContentType&&(d.headers["Content-Type"]="application/json"),b.body&&(d.body=b.body),b.withProgress){var f=new _rxjs.Subject;d.progressSubscriber=_rxjs.Subscriber.create(function(a){var c=Math.round,d=c(100*(a.loaded/a.total));f.next(b.withProgress(d))})}return d}},{key:"addRequestMiddlewares",value:function f(a){for(var b=this,c=arguments.length,d=Array(1<c?c-1:0),e=1;e<c;e++)d[e-1]=arguments[e];a.forEach(function(a){b.requestMiddlewares.find(function(b){return b.name===a.name})||(b.requestMiddlewares=[].concat((0,_toConsumableArray3.default)(b.requestMiddlewares),[{name:a.name,handler:function b(){return a.handler.apply(a,d)}}]))})}},{key:"addErrorMiddlewares",value:function f(a){for(var b=this,c=arguments.length,d=Array(1<c?c-1:0),e=1;e<c;e++)d[e-1]=arguments[e];a.forEach(function(a){b.errorMiddlewares=[].concat((0,_toConsumableArray3.default)(b.errorMiddlewares),[{name:a.name,handler:function c(b){return a.handler.apply(a,[b].concat(d))}}])})}},{key:"init",value:function c(){var a=this,b={};Object.keys(this.apiDefs).forEach(function(c){b=(0,_extends4.default)({},b,(0,_defineProperty3.default)({},""+c,function e(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{params:{},body:null,query:{}},d=(0,_ajax.ajax)(a.defBuilder(a.apiDefs[c],b));return d.pipe((0,_operators.catchError)(function(b){throw a.errorMiddlewares.forEach(function(d){a.apiDefs[c].ignoreMiddlewares&&a.apiDefs[c].ignoreMiddlewares.find(function(a){return a===d.name})||d.handler(b)}),b}))}))}),this.routes=b}}]),a}();exports.default=RxjsWrapper;